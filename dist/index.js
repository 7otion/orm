"use strict";var j=Object.create;var v=Object.defineProperty;var F=Object.getOwnPropertyDescriptor;var W=Object.getOwnPropertyNames;var z=Object.getPrototypeOf,k=Object.prototype.hasOwnProperty;var U=(u,e)=>{for(var t in e)v(u,t,{get:e[t],enumerable:!0})},D=(u,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of W(e))!k.call(u,s)&&s!==t&&v(u,s,{get:()=>e[s],enumerable:!(r=F(e,s))||r.enumerable});return u};var B=(u,e,t)=>(t=u!=null?j(z(u)):{},D(e||!u||!u.__esModule?v(t,"default",{value:u,enumerable:!0}):t,u)),H=u=>D(v({},"__esModule",{value:!0}),u);var J={};U(J,{LocalStorageResultCache:()=>Q,MemoryResultCache:()=>L,Model:()=>C,ORM:()=>y,QueryBuilder:()=>g,Relationship:()=>b,SQLiteDialect:()=>O,StatementCache:()=>N,TauriAdapter:()=>K,getRepository:()=>q});module.exports=H(J);var y=class u{static instance=null;adapter;dialect;writeQueue=Promise.resolve();enableWriteQueue=!1;resultCacheAdapter;disableResultCache=!1;connectionId="default";constructor(e){this.adapter=e.adapter,this.dialect=e.dialect,this.enableWriteQueue=e.enableWriteQueue??!1,this.resultCacheAdapter=e.resultCacheAdapter,this.disableResultCache=e.disableResultCache??!1}async cachedSelect(e,t=[],r=[]){if(this.disableResultCache||this.adapter.inTransaction()||!this.resultCacheAdapter)return this.adapter.query(e,t);let s=e.match(/^SELECT \* FROM ([^ ]+) WHERE (.+)$/i);if(s){let c=s[1],n=s[2];if(!c)throw new Error("Unable to determine table name for caching.");if(!n)throw new Error("Unable to determine WHERE clause for caching.");let o=n.match(/^id\s*=\s*\?/i),p=n.match(/^id\s+IN\s*\((.+)\)/i);if(o&&t.length===1){let d=this.resultCacheAdapter.getRowById?.(c,t[0]);if(d)return[d];let f=await this.adapter.query(e,t);return f[0]&&this.resultCacheAdapter.setRowById?.(c,t[0],f[0]),f}else if(p){let d=t,f=[],m=[];for(let h of d){let w=this.resultCacheAdapter.getRowById?.(c,h);w?f.push(w):m.push(h)}let T=[];if(m.length>0){let h=m.map(()=>"?").join(", "),w=`SELECT * FROM ${c} WHERE id IN (${h})`;T=await this.adapter.query(w,m);for(let R of T)this.resultCacheAdapter.setRowById?.(c,R.id,R)}let M=new Map;for(let h of f)M.set(h.id,h);for(let h of T)M.set(h.id,h);return d.map(h=>M.get(h)).filter(Boolean)}}let a=this.makeCacheKey(e,t),i=this.resultCacheAdapter.get(a);if(i)return i;let l=await this.adapter.query(e,t);return this.resultCacheAdapter.set(a,l,r),l}invalidateResultCache(e){this.resultCacheAdapter&&this.resultCacheAdapter.invalidate(e)}makeCacheKey(e,t){let r=e.replace(/\s+/g," ").trim().toLowerCase(),s=a=>Array.isArray(a)?"["+a.map(s).join(",")+"]":a&&typeof a=="object"?"{"+Object.keys(a).sort().map(i=>JSON.stringify(i)+":"+s(a[i])).join(",")+"}":JSON.stringify(a);return`${this.connectionId}|${r}|${s(t)}`}setResultCacheDisabled(e){this.disableResultCache=e}static initialize(e){u.instance||(u.instance=new u(e))}static getInstance(){if(!u.instance)throw new Error("ORM not initialized. Call ORM.initialize() first.");return u.instance}getAdapter(){return this.adapter}getDialect(){return this.dialect}async transaction(e){let t=this.adapter.inTransaction();t||await this.adapter.beginTransaction();try{let r=await e();return t||await this.adapter.commit(),r}catch(r){throw t||await this.adapter.rollback(),r}}async queueWrite(e){if(!this.enableWriteQueue)return e();let t=this.writeQueue.then(()=>e());return this.writeQueue=t.catch(()=>{}),t}};var g=class{query;modelClass;eagerLoad=new Map;relationshipConstraint;constructor(e,t){this.modelClass=e,this.query={table:t,wheres:[],orders:[]}}where(e,t,r){let s,a;r===void 0?(s="=",a=t):(s=t,a=r);let i={type:"basic",column:String(e),operator:s,value:a};return this.query.wheres.push(i),this}whereRaw(e,t=[]){let r={type:"raw",sql:e,bindings:t};return this.query.wheres.push(r),this}whereIn(e,t){return this.query.wheres.push({type:"basic",column:String(e),operator:"IN",value:t}),this}join(e,t,r,s,a){return this.query.joins||(this.query.joins=[]),this.query.joins.push({type:e,table:t,first:r,operator:s,second:a}),this}innerJoin(e,t,r,s){return this.join("INNER",e,t,r,s)}leftJoin(e,t,r,s){return this.join("LEFT",e,t,r,s)}orderBy(e,t="asc"){return this.query.orders.push({column:e,direction:t}),this}orderByRaw(e){return this.query.orders.push({column:e,direction:"raw"}),this}limit(e){return this.query.limitValue=e,this}offset(e){return this.query.offsetValue=e,this}select(...e){return this.query.columns=e.map(String),this}selectRaw(e){return this.query.selectRaw=e,this}with(...e){for(let t of e)this.eagerLoad.set(t,t);return this}extractTableNames(){let e=new Set;if(e.add(this.query.table),this.query.joins)for(let t of this.query.joins)e.add(t.table);return Array.from(e)}setRelationshipConstraint(e){return this.relationshipConstraint=e,this}async get(){this.relationshipConstraint&&this.relationshipConstraint(this);let e=y.getInstance(),r=e.getDialect().compileSelect(this.query),s=e.resultCacheAdapter?this.extractTableNames():[],i=(await e.cachedSelect(r.sql,r.bindings,s)).map(l=>this.hydrate(l));return this.eagerLoad.size>0&&await this.loadRelationships(i),i}async first(){this.limit(1);let e=await this.get();return e.length>0?e[0]:null}async paginate(e=1,t=20){this.relationshipConstraint&&this.relationshipConstraint(this);let r=y.getInstance(),s=r.getDialect(),a={...this.query},i=s.compileCount(a),l=this.extractTableNames(),n=(await r.cachedSelect(i.sql,i.bindings,l))[0]?.count||0,o=(e-1)*t;this.limit(t).offset(o);let p=s.compileSelect(this.query),d=this.extractTableNames(),m=(await r.cachedSelect(p.sql,p.bindings,d)).map(T=>this.hydrate(T));return this.eagerLoad.size>0&&await this.loadRelationships(m),{data:m,total:n}}async delete(){this.relationshipConstraint&&this.relationshipConstraint(this);let e=y.getInstance();return e.queueWrite(async()=>{let t=e.getDialect(),r=e.getAdapter(),s=t.compileDeleteQuery(this.query),a=await r.execute(s.sql,s.bindings),i=this.extractTableNames();return e.invalidateResultCache(i),a})}hydrate(e){let t=new this.modelClass;return t._attributes={...e},t._original={...e},t._exists=!0,t}async loadRelationships(e){if(e.length===0)return;let r=e[0].constructor,s=r.relationships;if(!(!s||Object.keys(s).length===0)){for(let a of this.eagerLoad.keys())if(a.includes("."))await this.loadNestedRelationship(e,a,s);else{let i=s[a];if(!i)continue;typeof i.eagerLoadFor=="function"&&await i.eagerLoadFor(e,a)}typeof r.afterEagerLoad=="function"&&await r.afterEagerLoad(this.eagerLoad.keys(),e)}}async loadNestedRelationship(e,t,r){let s=t.split("."),a=s[0],i=s.slice(1).join("."),l=r?.[a];if(!l)throw new Error(`Relationship '${a}' not found in static relationships constant`);if(typeof l.eagerLoadFor=="function"&&await l.eagerLoadFor(e,a),i){let n=this.getRelatedModelsFromLoadedRelationship(e,a).filter(o=>o!=null);n.length>0&&await this.loadNestedRelationshipOnRelatedModels(n,i,l.getRelated())}}getRelatedModelsFromLoadedRelationship(e,t){let r=[];for(let s of e){let a=`_${t}`,i=s[a];i!=null&&(Array.isArray(i)?r.push(...i):r.push(i))}return r}async loadNestedRelationshipOnRelatedModels(e,t,r){let s=r.relationships;if(!(!s||Object.keys(s).length===0))if(t.includes("."))await this.loadNestedRelationship(e,t,s);else{let a=s[t];if(!a)throw new Error(`Relationship '${t}' not found in ${r.name} relationships`);typeof a.eagerLoadFor=="function"&&await a.eagerLoadFor(e,t)}}getQuery(){return this.query}};var b=class{parentConstructor;related;foreignKey;localKey;constructor(e,t,r,s){if(typeof e=="function"?this.parentConstructor=e:this.parentConstructor=e.constructor,this.related=t,r)this.foreignKey=r;else{let i=this.parentConstructor.name.replace(/Model$/,"").replace(/([A-Z])/g,"_$1").toLowerCase().replace(/^_/,"");this.foreignKey=`${i}_id`}if(s)this.localKey=s;else{let a=this.parentConstructor.config?.primaryKey||"id";this.localKey=Array.isArray(a)?a[0]:a}}getParentKeyValue(e){return e[this.localKey]}getRelated(){return this.related}getForeignKey(){return this.foreignKey}getLocalKey(){return this.localKey}};var A=class extends b{async get(e){let t=this.related.getTableName(),r=new g(this.related,t),s=this.getParentKeyValue(e);return r.where(this.foreignKey,s),r.first()}async eagerLoadFor(e,t){let r=e.map(o=>o[this.localKey]);if(!r.some(o=>o!=null)){for(let o of e)o[`_${t}`]=null;return}let a=[...new Set(r.filter(o=>o!=null))],i=this.related.getTableName(),c=await new g(this.related,i).where(this.foreignKey,"IN",a).get(),n=new Map;for(let o of c){let p=o[this.foreignKey];n.set(p,o)}for(let o of e){let p=o[this.localKey],d=n.get(p)||null;o[`_${t}`]=d}}};var $=class extends b{async get(e){let t=this.related.getTableName(),r=new g(this.related,t),s=this.getParentKeyValue(e);return r.where(this.foreignKey,s),r.get()}async eagerLoadFor(e,t){let r=e.map(o=>o[this.localKey]);if(!r.some(o=>o!=null)){for(let o of e)o[`_${t}`]=[];return}let a=[...new Set(r.filter(o=>o!=null))],i=this.related.getTableName(),c=await new g(this.related,i).where(this.foreignKey,"IN",a).get(),n=new Map;for(let o of c){let p=o[this.foreignKey];n.has(p)||n.set(p,[]),n.get(p).push(o)}for(let o of e){let p=o[this.localKey],d=n.get(p)||[];o[`_${t}`]=d}}};var E=class extends b{constructor(e,t,r,s){if(super(e,t,r,s),!r){let a=this.related.name.replace(/Model$/,"").replace(/([A-Z])/g,"_$1").toLowerCase().replace(/^_/,"");this.foreignKey=`${a}_id`}if(!s){let a=this.related.config?.primaryKey||"id";this.localKey=Array.isArray(a)?a[0]:a}}async get(e){let t=this.related.getTableName(),r=new g(this.related,t),s=e[this.foreignKey];return r.where(this.localKey,s),r.first()}async eagerLoadFor(e,t){let r=e.map(o=>o[this.foreignKey]);if(!r.some(o=>o!=null)){for(let o of e)o[`_${t}`]=null;return}let a=[...new Set(r.filter(o=>o!=null))],i=this.related.getTableName(),c=await new g(this.related,i).where(this.localKey,"IN",a).get(),n=new Map;for(let o of c){let p=o[this.localKey];n.set(p,o)}for(let o of e){let p=o[this.foreignKey],d=n.get(p)||null;o[`_${t}`]=d}}};var S=class extends b{pivotTable;foreignPivotKey;relatedPivotKey;parentKey;relatedKey;constructor(e,t,r,s,a,i,l){if(super(e,t,s,i),this.pivotTable=r,s)this.foreignPivotKey=s;else{let o=this.parentConstructor.name.replace(/Model$/,"").replace(/([A-Z])/g,"_$1").toLowerCase().replace(/^_/,"");this.foreignPivotKey=`${o}_id`}if(a)this.relatedPivotKey=a;else{let o=t.name.replace(/Model$/,"").replace(/([A-Z])/g,"_$1").toLowerCase().replace(/^_/,"");this.relatedPivotKey=`${o}_id`}let c=i||this.parentConstructor.config?.primaryKey||"id",n=l||t.config?.primaryKey||"id";this.parentKey=Array.isArray(c)?c[0]:c,this.relatedKey=Array.isArray(n)?n[0]:n}async get(e){let t=this.related.getTableName(),r=this.getParentKeyValue(e),s=new g(this.related,t);return s.innerJoin(this.pivotTable,`${t}.${this.relatedKey}`,"=",`${this.pivotTable}.${this.relatedPivotKey}`),s.where(`${this.pivotTable}.${this.foreignPivotKey}`,r),s.get()}async eagerLoadFor(e,t){let r=e.map(h=>h[this.parentKey]);if(!r.some(h=>h!=null)){for(let h of e)h[`_${t}`]=[];return}let a=[...new Set(r.filter(h=>h!=null))],i=y.getInstance(),l=i.getDialect(),c=i.getAdapter(),n=l.compileSelect({table:this.pivotTable,wheres:[{type:"basic",column:this.foreignPivotKey,operator:"IN",value:a}],orders:[]}),o=await c.query(n.sql,n.bindings);if(o.length===0){for(let h of e)h[t]=[];return}let p=[...new Set(o.map(h=>h[this.relatedPivotKey]))],d=this.related.getTableName(),m=await new g(this.related,d).where(this.relatedKey,"IN",p).get(),T=new Map;for(let h of m){let w=h[this.relatedKey];T.set(w,h)}let M=new Map;for(let h of o){let w=h[this.foreignPivotKey],R=h[this.relatedPivotKey],V=T.get(R);V&&(M.has(w)||M.set(w,[]),M.get(w).push(V))}for(let h of e){let w=h[this.parentKey],R=M.get(w)||[];h[`_${t}`]=R}}};var x=class{constructor(e,t){this.parent=e;this.config=t}async get(e){let t=e||this.parent,r=t[this.config.discriminatorField],s=t[this.config.foreignKeyField];if(!r||s===null)return null;let a=this.config.morphMap[r];return a?a.find(s):(console.warn(`No model mapped for discriminator value: ${r}`),null)}async eagerLoadFor(e,t){let r=new Map;for(let s of e){let a=s[this.config.discriminatorField];if(!a){s[`_${t}`]=null;continue}r.has(a)||r.set(a,[]),r.get(a).push(s)}for(let[s,a]of r.entries()){let i=this.config.morphMap[s];if(!i){console.warn(`No model mapped for discriminator value: ${s}`);for(let d of a)d[`_${t}`]=null;continue}let l=a.map(d=>d[this.config.foreignKeyField]).filter(d=>d!=null);if(l.length===0){for(let d of a)d[`_${t}`]=null;continue}let c=[...new Set(l)],n=i.config.primaryKey||"id";n=Array.isArray(n)?n[0]:n;let o=await i.query().where(n,"IN",c).get(),p=new Map;for(let d of o){let f=d[n];p.set(f,d)}for(let d of a){let f=d[this.config.foreignKeyField],m=p.get(f)||null;d[`_${t}`]=m}}}};var _=class{async save(){let e=this;return this.generateSlugIfNeeded(),e._exists?this.update():this.insert()}generateSlugIfNeeded(){let e=this,t=e.constructor;if(!("slug"in e||"slug"in t.prototype)||e._attributes.slug)return;let s=e._attributes.name||e._attributes.title;!s||typeof s!="string"||(e._attributes.slug=t.generateSlug(s))}async insert(){let e=y.getInstance(),t=this;return e.queueWrite(async()=>{let r=e.getDialect(),s=e.getAdapter(),a=t.getConfig(),i=t.getTimestampConfig();if(i){let n=r.getCurrentTimestamp();t._attributes[i.created_at]=n,t._attributes[i.updated_at]=n}let l=r.compileInsert(a.table,t._attributes),c=await s.insert(l.sql,l.bindings);return Array.isArray(a.primaryKey)||(t._attributes[a.primaryKey]=c),t._exists=!0,t._original={...t._attributes},e.invalidateResultCache([a.table]),this})}async update(){let e=this;if(!e._exists)throw new Error("Cannot update a model that does not exist. Use insert() instead.");let t=y.getInstance();return t.queueWrite(async()=>{let r=t.getDialect(),s=t.getAdapter(),a=e.getConfig(),i=e.getTimestampConfig(),l=e.getDirty();if(l.length===0)return this;let c={};for(let d of l)c[d]=e._attributes[d];if(i){let d=r.getCurrentTimestamp();c[i.updated_at]=d,e._attributes[i.updated_at]=d}let n=a.primaryKey,o;Array.isArray(n)?o=n.map(d=>e._attributes[d]):o=e._attributes[n];let p=r.compileUpdate(a.table,c,n,o);return await s.execute(p.sql,p.bindings),e._original={...e._attributes},e.clearRelationships(),t.invalidateResultCache([a.table]),this})}async delete(){let e=this;if(!e._exists)throw new Error("Cannot delete a model that does not exist.");let t=y.getInstance();return t.queueWrite(async()=>{let r=t.getDialect(),s=t.getAdapter(),a=e.getConfig(),i=a.primaryKey,l;Array.isArray(i)?l=i.map(n=>e._attributes[n]):l=e._attributes[i];let c=r.compileDelete(a.table,i,l);return await s.execute(c.sql,c.bindings),e._exists=!1,t.invalidateResultCache([a.table]),!0})}};var P=class{get isDirty(){return this.getDirty().length>0}getDirty(){let e=this,t=[];for(let r in e._attributes)e._attributes[r]!==e._original[r]&&t.push(r);return t}getChanges(){let e=this,t={};for(let r of this.getDirty())t[r]={old:e._original[r],new:e._attributes[r]};return t}};var I=class{getWithSuspense(e){let t=this,r=`_${e}`;if(t[r]!==void 0)return t[r];let s=`_loading_${e}`;if(t[s])throw t[s];let a=this.loadRelationship(e).then(()=>{delete t[s]});throw t[s]=a,a}async load(e){let t=this,r=`_${e}`;if(t[r]!==void 0)return;let s=`_loading_${e}`;if(t[s]){await t[s];return}let a=this.loadRelationship(e);t[s]=a;try{await a,delete t[s]}catch(i){throw delete t[s],i}}async loadRelationship(e){let t=this,r=t.constructor.relationships[e];if(r){if(typeof r.get!="function")throw new Error(`Relationship '${e}' must have a get() method`);let s=t._proxy||this,a=await r.get(s);t[`_${e}`]=a}else{let s=`load${e.charAt(0).toUpperCase()}${e.slice(1)}`,a=t.constructor[s];if(typeof a=="function")await a([this]);else throw new Error(`Relationship '${e}' not found in static relationships constant and no custom loader '${s}' available`)}}clearRelationships(){let e=this;for(let t in e.constructor.relationships){let r=`_${t}`;r in e&&delete e[r]}}};var C=class u{static _relationshipsCache=new WeakMap;static defineRelationships(){return{}}static get relationships(){return u._relationshipsCache.has(this)||u._relationshipsCache.set(this,this.defineRelationships()),u._relationshipsCache.get(this)}static config={timestamps:!0};_attributes={};_original={};_exists=!1;_proxy;relationships={};constructor(){let e=new Proxy(this,{get(t,r){if(typeof r=="symbol"||r.startsWith("_"))return t[r];if(r==="constructor")return Object.getPrototypeOf(t).constructor;let s=Object.getPrototypeOf(t);for(;s;){let l=Object.getOwnPropertyDescriptor(s,r);if(l){if(l.get)return l.get.call(e);if(typeof l.value=="function")return l.value.bind(e)}s=Object.getPrototypeOf(s)}if(r in t._attributes)return t._attributes[r];if(Object.prototype.hasOwnProperty.call(t,r)){let l=t[r];if(l!==void 0)return l}let i=Object.getPrototypeOf(t).constructor.relationships;if(i&&i[r])return t.getWithSuspense(r)},set(t,r,s){if(typeof r=="symbol"||r.startsWith("_"))return t[r]=s,!0;let a=Object.getOwnPropertyDescriptor(Object.getPrototypeOf(t),r);return a&&a.set?(a.set.call(t,s),!0):a&&typeof a.value=="function"?!1:(t._attributes[r]=s,!0)},ownKeys(t){return Object.keys(t._attributes)},getOwnPropertyDescriptor(t,r){if(typeof r=="string"&&r in t._attributes)return{enumerable:!0,configurable:!0,writable:!0,value:t._attributes[r]}}});return this._proxy=e,e}getConfig(){let e=this.constructor,t=e.config,r=t.table;return r||(r=this.deriveTableName(e.name)),{table:r,primaryKey:t.primaryKey||"id",timestamps:t.timestamps||!1}}deriveTableName(e){let t=e.replace(/([A-Z])/g,"_$1").toLowerCase().replace(/^_/,"");return t.endsWith("y")?t.slice(0,-1)+"ies":t.endsWith("s")?t+"es":t+"s"}getTimestampConfig(){let e=this.getConfig();return e.timestamps?typeof e.timestamps=="boolean"?{created_at:"created_at",updated_at:"updated_at"}:e.timestamps:null}static getTableName(){let e=this;if(e.config.table)return e.config.table;if(!e._cachedTableName){let r=(this.name||"Model").replace(/([A-Z])/g,"_$1").toLowerCase().replace(/^_/,"");r.endsWith("y")?e._cachedTableName=r.slice(0,-1)+"ies":r.endsWith("s")?e._cachedTableName=r+"es":e._cachedTableName=r+"s"}return e._cachedTableName}static generateSlug(e){return e.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")}static query(){let e=this.getTableName();return new g(this,e)}static async find(e){let t=this.config.primaryKey||"id";if(Array.isArray(t)){let r=Array.isArray(e)?e:[e];if(t.length!==r.length)throw new Error(`Primary key length mismatch: expected ${t.length} values, got ${r.length}`);let s=this.query();for(let a=0;a<t.length;a++){let i=t[a],l=r[a];if(i===void 0||l===void 0)throw new Error("Unexpected undefined in composite primary key");s=s.where(i,l)}return s.first()}return this.query().where(t,e).first()}static async all(){return this.query().get()}static async create(e){let t=new this;for(let[r,s]of Object.entries(e))t[r]=s;return await t.save(),t}static hasOne(e,t,r){return new A(this,e,t,r)}static hasMany(e,t,r){return new $(this,e,t,r)}static belongsTo(e,t,r){return new E(this,e,t,r)}static belongsToMany(e,t,r,s,a,i){return new S(this,e,t,r,s,a,i)}static morphTo(e){return new x(this,e)}async refresh(){let e=this,r=this.getConfig().primaryKey||"id",s=e.constructor.query();if(Array.isArray(r))for(let n of r){let o=e._attributes[n];if(o==null)throw new Error(`Cannot refresh model without primary key value for ${n}`);s=s.where(n,o)}else{let n=e._attributes[r];if(!n)throw new Error("Cannot refresh model without a primary key value");s=s.where(r,n)}let a=[],l=Object.getPrototypeOf(e).constructor.relationships;if(l)for(let n in l){let o=`_${n}`;o in e&&e[o]!==void 0&&a.push(n)}let c=await s.first();if(!c){let n=Array.isArray(r)?r.map(o=>`${o}=${e._attributes[o]}`).join(", "):`${r}=${e._attributes[r]}`;throw new Error(`Model with ${n} no longer exists`)}e._attributes={...c._attributes},e._original={...c._original},e._exists=c._exists;for(let n of a){let o=`_${n}`,p=`_loading_${n}`;delete e[o],delete e[p],await e.load(n)}}};function Y(u,e){e.forEach(t=>{Object.getOwnPropertyNames(t.prototype).forEach(r=>{if(r!=="constructor"){let s=Object.getOwnPropertyDescriptor(t.prototype,r);s&&Object.defineProperty(u.prototype,r,s)}})})}Y(C,[_,P,I]);function q(u){let e=u,t={query(){return e.query()},async find(a){return await e.find(a)},async all(){return await e.all()},async create(a){return await e.create(a)}},r={},s=u;for(;s&&s!==C&&s!==Function.prototype;)Object.getOwnPropertyNames(s).forEach(a=>{if(a==="constructor"||a==="config"||a==="length"||a==="name"||a==="prototype"||a in t)return;let i=Object.getOwnPropertyDescriptor(s,a);i&&typeof i.value=="function"&&(r[a]=i.value.bind(u))}),s=Object.getPrototypeOf(s);return{...t,...r}}var N=class{cache=new Map;maxSize;constructor(e=200){this.maxSize=e}get(e){let t=this.cache.get(e);if(t)return t.lastUsed=Date.now(),t.statement}set(e,t){this.cache.size>=this.maxSize&&!this.cache.has(e)&&this.evictOldest(),this.cache.set(e,{statement:t,lastUsed:Date.now()})}has(e){return this.cache.has(e)}delete(e){this.cache.delete(e)}clear(){this.cache.clear()}size(){return this.cache.size}evictOldest(){let e=null,t=1/0;for(let[r,s]of this.cache.entries())s.lastUsed<t&&(t=s.lastUsed,e=r);e&&this.cache.delete(e)}};var O=class{compileSelect(e){let t=[],r="SELECT ";if(e.selectRaw?r+=e.selectRaw:e.columns&&e.columns.length>0?r+=e.columns.join(", "):r+="*",r+=` FROM ${e.table}`,e.joins&&e.joins.length>0)for(let s of e.joins)r+=` ${s.type} JOIN ${s.table} ON ${s.first} ${s.operator} ${s.second}`;if(e.wheres.length>0){r+=" WHERE ";let s=[];for(let a of e.wheres)if(a.type==="raw")s.push(`(${a.sql})`),a.bindings&&t.push(...a.bindings);else{let{column:i,operator:l,value:c}=a;if(l==="IN"||l==="NOT IN"){let n=Array.isArray(c)?c:[c],o=n.map(()=>"?").join(", ");s.push(`${i} ${l} (${o})`),t.push(...n)}else l==="IS"||l==="IS NOT"?s.push(`${i} ${l} NULL`):(s.push(`${i} ${l} ?`),t.push(c))}r+=s.join(" AND ")}if(e.orders.length>0){r+=" ORDER BY ";let s=e.orders.map(a=>a.direction==="raw"?a.column:`${this.escapeIdentifier(a.column)} ${a.direction.toUpperCase()}`);r+=s.join(", ")}return e.limitValue!==void 0&&(r+=" LIMIT ?",t.push(e.limitValue)),e.offsetValue!==void 0&&(r+=" OFFSET ?",t.push(e.offsetValue)),{sql:r,bindings:t}}compileInsert(e,t){let r=Object.keys(t),s=Object.values(t),a=r.map(c=>this.escapeIdentifier(c)).join(", "),i=r.map(()=>"?").join(", ");return{sql:`INSERT INTO ${e} (${a}) VALUES (${i})`,bindings:s}}compileUpdate(e,t,r,s){let a=Object.keys(t),i=Object.values(t),l=a.map(d=>`${this.escapeIdentifier(d)} = ?`).join(", "),c,n;if(Array.isArray(r)){let d=r,f=Array.isArray(s)?s:[s];if(d.length!==f.length)throw new Error(`Primary key length mismatch: expected ${d.length} values, got ${f.length}`);c=d.map(T=>`${this.escapeIdentifier(T)} = ?`).join(" AND "),n=f}else c=`${this.escapeIdentifier(r)} = ?`,n=[s];let o=`UPDATE ${e} SET ${l} WHERE ${c}`,p=[...i,...n];return{sql:o,bindings:p}}compileDelete(e,t,r){let s,a;if(Array.isArray(t)){let l=t,c=Array.isArray(r)?r:[r];if(l.length!==c.length)throw new Error(`Primary key length mismatch: expected ${l.length} values, got ${c.length}`);s=l.map(o=>`${this.escapeIdentifier(o)} = ?`).join(" AND "),a=c}else s=`${this.escapeIdentifier(t)} = ?`,a=[r];return{sql:`DELETE FROM ${e} WHERE ${s}`,bindings:a}}compileDeleteQuery(e){let t=[],r=`DELETE FROM ${e.table}`;if(e.joins&&e.joins.length>0)for(let s of e.joins)r+=` ${s.type} JOIN ${s.table} ON ${s.first} ${s.operator} ${s.second}`;if(e.wheres.length>0){r+=" WHERE ";let s=[];for(let a of e.wheres)if(a.type==="raw")s.push(`(${a.sql})`),a.bindings&&t.push(...a.bindings);else{let{column:i,operator:l,value:c}=a;if(l==="IN"||l==="NOT IN"){let n=Array.isArray(c)?c:[c],o=n.map(()=>"?").join(", ");s.push(`${i} ${l} (${o})`),t.push(...n)}else l==="IS"||l==="IS NOT"?s.push(`${i} ${l} NULL`):(s.push(`${i} ${l} ?`),t.push(c))}r+=s.join(" AND ")}if(e.orders.length>0){r+=" ORDER BY ";let s=e.orders.map(a=>a.direction==="raw"?a.column:`${this.escapeIdentifier(a.column)} ${a.direction.toUpperCase()}`);r+=s.join(", ")}return e.limitValue!==void 0&&(r+=" LIMIT ?",t.push(e.limitValue)),e.offsetValue!==void 0&&(r+=" OFFSET ?",t.push(e.offsetValue)),{sql:r,bindings:t}}compileCount(e){let t=[],r=`SELECT COUNT(*) as count FROM ${e.table}`;if(e.joins&&e.joins.length>0)for(let s of e.joins)r+=` ${s.type} JOIN ${s.table} ON ${s.first} ${s.operator} ${s.second}`;if(e.wheres.length>0){r+=" WHERE ";let s=[];for(let a of e.wheres)if(a.type==="raw")s.push(`(${a.sql})`),a.bindings&&t.push(...a.bindings);else{let{column:i,operator:l,value:c}=a;if(l==="IN"||l==="NOT IN"){let n=Array.isArray(c)?c:[c],o=n.map(()=>"?").join(", ");s.push(`${i} ${l} (${o})`),t.push(...n)}else l==="IS"||l==="IS NOT"?s.push(`${i} ${l} NULL`):(s.push(`${i} ${l} ?`),t.push(c))}r+=s.join(" AND ")}return{sql:r,bindings:t}}getCurrentTimestamp(){return new Date().toISOString()}escapeIdentifier(e){return e.includes(".")?e.split(".").map(t=>this.escapeIdentifier(t)).join("."):`"${e.replace(/"/g,'""')}"`}};var K=class{db=null;inTransactionFlag=!1;debug=!1;config;initPromise=null;constructor(e){this.config=e,this.debug=e.debug||!1}async initialize(){return this.initPromise?this.initPromise:(this.initPromise=this.performInitialization(),this.initPromise)}async performInitialization(){if(this.db)return;let e;try{e=await import("@tauri-apps/plugin-sql")}catch{throw new Error("@tauri-apps/plugin-sql is required for TauriAdapter. Install it with: npm install @tauri-apps/plugin-sql")}this.db=await e.default.load(this.config.database);let t=["PRAGMA journal_mode = WAL;","PRAGMA foreign_keys = ON;","PRAGMA case_sensitive_like = OFF;","PRAGMA busy_timeout = 30000;","PRAGMA synchronous = NORMAL;"],r=this.config.pragmas||t;for(let s of r)await this.db.execute(s)}ensureInitialized(){if(!this.db)throw new Error("TauriAdapter not initialized. Call initialize() first.");return this.db}logQuery(e,t,r){if(!this.debug)return;let s=this.formatSqlWithParams(t,r);console.log(`\u{1F539} [${e}]:`,s)}formatSqlWithParams(e,t){if(!t||t.length===0)return e;let r=e;for(let s of t){let a;s==null?a="NULL":typeof s=="string"?a=`'${s.replace(/'/g,"''")}'`:a=String(s),r=r.replace("?",a)}return r}async query(e,t){let r=this.ensureInitialized();return this.logQuery("SELECT",e,t),await r.select(e,t)||[]}async execute(e,t){let r=this.ensureInitialized();return this.logQuery("EXECUTE",e,t),(await r.execute(e,t)).rowsAffected||0}async insert(e,t){let r=this.ensureInitialized();return this.logQuery("INSERT",e,t),(await r.execute(e,t)).lastInsertId||0}async beginTransaction(){let e=this.ensureInitialized();this.inTransactionFlag||(await e.execute("BEGIN TRANSACTION"),this.inTransactionFlag=!0)}async commit(){let e=this.ensureInitialized();if(!this.inTransactionFlag)throw new Error("No transaction in progress");await e.execute("COMMIT"),this.inTransactionFlag=!1}async rollback(){let e=this.ensureInitialized();if(!this.inTransactionFlag)throw new Error("No transaction in progress");await e.execute("ROLLBACK"),this.inTransactionFlag=!1}inTransaction(){return this.inTransactionFlag}};var L=class{cache=new Map;tagMap=new Map;rowCache=new Map;maxSize;defaultTTL;debug;constructor(e=200,t,r=!1){this.maxSize=e,this.defaultTTL=t,this.debug=r}get(e){let t=this.cache.get(e);if(!t){this.debug&&console.log("[MemoryResultCache] MISS (query)",e);return}if(t.expiresAt&&Date.now()>t.expiresAt){this.debug&&console.log("[MemoryResultCache] EXPIRED (query)",e),this.delete(e,t.tags);return}return t.lastUsed=Date.now(),this.debug&&console.log("[MemoryResultCache] HIT (query)",e),t.value}set(e,t,r,s){this.cache.size>=this.maxSize&&!this.cache.has(e)&&this.evictOldest();let a=s||this.defaultTTL?Date.now()+(s||this.defaultTTL):void 0;this.cache.set(e,{value:t,tags:r,expiresAt:a,lastUsed:Date.now()});for(let i of r)this.tagMap.has(i)||this.tagMap.set(i,new Set),this.tagMap.get(i).add(e);this.debug&&console.log("[MemoryResultCache] SET (query)",e,{tags:r})}getRowById(e,t){let r=this.rowCache.get(e);if(!r){this.debug&&console.log(`[MemoryResultCache] MISS (row) ${e} id=${t}`);return}let s=r.get(t);return s?this.debug&&console.log(`[MemoryResultCache] HIT (row) ${e} id=${t}`):this.debug&&console.log(`[MemoryResultCache] MISS (row) ${e} id=${t}`),s}setRowById(e,t,r){this.rowCache.has(e)||this.rowCache.set(e,new Map),this.rowCache.get(e).set(t,r),this.debug&&console.log(`[MemoryResultCache] SET (row) ${e} id=${t}`,r)}invalidate(e){for(let t of e){let r=this.tagMap.get(t);if(r){for(let s of r){let a=this.cache.get(s);a&&this.delete(s,a.tags)}this.tagMap.delete(t),this.debug&&console.log("[MemoryResultCache] INVALIDATE",t),this.rowCache.has(t)&&(this.rowCache.delete(t),this.debug&&console.log("[MemoryResultCache] INVALIDATE (row)",t))}}}clear(){this.cache.clear(),this.tagMap.clear(),this.rowCache.clear(),this.debug&&console.log("[MemoryResultCache] CLEAR ALL")}size(){return this.cache.size}delete(e,t){this.cache.delete(e);for(let r of t){let s=this.tagMap.get(r);s&&(s.delete(e),s.size===0&&this.tagMap.delete(r))}}evictOldest(){let e=null,t=1/0;for(let[r,s]of this.cache.entries())s.lastUsed<t&&(t=s.lastUsed,e=r);if(e){let r=this.cache.get(e);r&&this.delete(e,r.tags)}}};var Q=class{prefix;defaultTTL;debug;maxEntries;get QUERY_CACHE_KEY(){return`${this.prefix}:queries`}get TAG_MAP_KEY(){return`${this.prefix}:tags`}get ROW_CACHE_KEY(){return`${this.prefix}:rows`}constructor(e="orm-cache",t=100,r,s=!1){this.prefix=e,this.maxEntries=t,this.defaultTTL=r,this.debug=s,this.cleanup()}get(e){try{let r=this.getQueriesMap().get(e);if(!r){this.debug&&console.log("[LocalStorageResultCache] MISS (query)",e);return}if(r.expiresAt&&Date.now()>r.expiresAt){this.debug&&console.log("[LocalStorageResultCache] EXPIRED (query)",e),this.delete(e,r.tags);return}return this.debug&&console.log("[LocalStorageResultCache] HIT (query)",e),r.value}catch(t){this.debug&&console.warn("[LocalStorageResultCache] Error getting query:",t);return}}set(e,t,r,s){try{let a=this.getQueriesMap(),i=this.getTagMap();a.size>=this.maxEntries&&!a.has(e)&&this.evictOldest();let l=s||this.defaultTTL?Date.now()+(s||this.defaultTTL):void 0,c={value:t,tags:r,expiresAt:l,createdAt:Date.now()};a.set(e,c);for(let n of r)i.has(n)||i.set(n,new Set),i.get(n).add(e);this.saveQueriesMap(a),this.saveTagMap(i),this.debug&&console.log("[LocalStorageResultCache] SET (query)",e,{tags:r})}catch(a){if(this.debug&&console.warn("[LocalStorageResultCache] Error setting query:",a),a instanceof DOMException&&a.name==="QuotaExceededError"){this.evictOldest();try{this.set(e,t,r,s)}catch(i){this.debug&&console.warn("[LocalStorageResultCache] Retry failed:",i)}}}}getRowById(e,t){try{let r=this.getRowsMap(),s=`${e}:${t}`,a=r.get(s);if(!a){this.debug&&console.log(`[LocalStorageResultCache] MISS (row) ${e} id=${t}`);return}if(a.expiresAt&&Date.now()>a.expiresAt){this.debug&&console.log(`[LocalStorageResultCache] EXPIRED (row) ${e} id=${t}`),r.delete(s),this.saveRowsMap(r);return}return this.debug&&console.log(`[LocalStorageResultCache] HIT (row) ${e} id=${t}`),a.row}catch(r){this.debug&&console.warn("[LocalStorageResultCache] Error getting row:",r);return}}setRowById(e,t,r){try{let s=this.getRowsMap(),a=`${e}:${t}`,i={row:r,expiresAt:this.defaultTTL?Date.now()+this.defaultTTL:void 0,createdAt:Date.now()};s.set(a,i),this.saveRowsMap(s),this.debug&&console.log(`[LocalStorageResultCache] SET (row) ${e} id=${t}`,r)}catch(s){this.debug&&console.warn("[LocalStorageResultCache] Error setting row:",s)}}invalidate(e){try{let t=this.getQueriesMap(),r=this.getTagMap(),s=this.getRowsMap(),a=0;for(let i of e){let l=r.get(i);if(l){for(let n of l)t.delete(n),a++;r.delete(i)}let c=[];for(let[n]of s)n.startsWith(`${i}:`)&&c.push(n);for(let n of c)s.delete(n),a++;this.debug&&console.log("[LocalStorageResultCache] INVALIDATE",i,`(${a} entries)`)}this.saveQueriesMap(t),this.saveTagMap(r),this.saveRowsMap(s)}catch(t){this.debug&&console.warn("[LocalStorageResultCache] Error invalidating:",t)}}clear(){try{localStorage.removeItem(this.QUERY_CACHE_KEY),localStorage.removeItem(this.TAG_MAP_KEY),localStorage.removeItem(this.ROW_CACHE_KEY),this.debug&&console.log("[LocalStorageResultCache] CLEAR ALL")}catch(e){this.debug&&console.warn("[LocalStorageResultCache] Error clearing:",e)}}size(){try{return this.getQueriesMap().size+this.getRowsMap().size}catch(e){return this.debug&&console.warn("[LocalStorageResultCache] Error getting size:",e),0}}getQueriesMap(){try{let e=localStorage.getItem(this.QUERY_CACHE_KEY);return e?new Map(JSON.parse(e)):new Map}catch(e){return this.debug&&console.warn("[LocalStorageResultCache] Error parsing queries:",e),new Map}}saveQueriesMap(e){try{localStorage.setItem(this.QUERY_CACHE_KEY,JSON.stringify([...e]))}catch(t){this.debug&&console.warn("[LocalStorageResultCache] Error saving queries:",t)}}getTagMap(){try{let e=localStorage.getItem(this.TAG_MAP_KEY);if(!e)return new Map;let t=JSON.parse(e),r=new Map;for(let[s,a]of t)r.set(s,new Set(a));return r}catch(e){return this.debug&&console.warn("[LocalStorageResultCache] Error parsing tags:",e),new Map}}saveTagMap(e){try{let t=[...e].map(([r,s])=>[r,[...s]]);localStorage.setItem(this.TAG_MAP_KEY,JSON.stringify(t))}catch(t){this.debug&&console.warn("[LocalStorageResultCache] Error saving tags:",t)}}getRowsMap(){try{let e=localStorage.getItem(this.ROW_CACHE_KEY);return e?new Map(JSON.parse(e)):new Map}catch(e){return this.debug&&console.warn("[LocalStorageResultCache] Error parsing rows:",e),new Map}}saveRowsMap(e){try{localStorage.setItem(this.ROW_CACHE_KEY,JSON.stringify([...e]))}catch(t){this.debug&&console.warn("[LocalStorageResultCache] Error saving rows:",t)}}delete(e,t){try{let r=this.getQueriesMap(),s=this.getTagMap();r.delete(e);for(let a of t){let i=s.get(a);i&&(i.delete(e),i.size===0&&s.delete(a))}this.saveQueriesMap(r),this.saveTagMap(s)}catch(r){this.debug&&console.warn("[LocalStorageResultCache] Error deleting:",r)}}evictOldest(){try{let e=this.getQueriesMap(),t=null,r=1/0;for(let[s,a]of e)a.createdAt<r&&(r=a.createdAt,t=s);if(t){let s=e.get(t);s&&this.delete(t,s.tags)}}catch(e){this.debug&&console.warn("[LocalStorageResultCache] Error evicting:",e)}}cleanup(){try{let e=this.getQueriesMap(),t=this.getRowsMap(),r=Date.now();for(let[s,a]of e)a.expiresAt&&r>a.expiresAt&&this.delete(s,a.tags);for(let[s,a]of t)a.expiresAt&&r>a.expiresAt&&t.delete(s);this.saveRowsMap(t)}catch(e){this.debug&&console.warn("[LocalStorageResultCache] Error cleaning up:",e)}}};
/**
 * 7otion ORM - Database-Agnostic TypeScript ORM
 *
 * A modern, type-safe ORM with Active Record pattern, designed to work
 * with any database through pluggable adapters and dialects.
 *
 * @author Burak Kartal
 * @license MIT
 */
